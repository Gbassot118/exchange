<div class="p-3 border-b border-gray-100 hover:bg-gray-50 annotation-item"
     id="annotation-{{ annotation.id }}"
     sse-swap="annotation.updated:outerHTML">

    <!-- Auteur et type -->
    <div class="flex items-center justify-between mb-2">
        <div class="flex items-center space-x-2">
            <span class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-medium"
                  style="background-color: {{ annotation.author.color }}">
                {{ annotation.author.pseudo|first|upper }}
            </span>
            <span class="font-medium text-sm text-gray-900">{{ annotation.author.pseudo }}</span>
        </div>
        <span class="px-2 py-0.5 text-xs rounded-full
            {% if annotation.type == 'question' %}bg-amber-100 text-amber-700
            {% elseif annotation.type == 'objection' %}bg-red-100 text-red-700
            {% elseif annotation.type == 'suggestion' %}bg-blue-100 text-blue-700
            {% elseif annotation.type == 'validation' %}bg-green-100 text-green-700
            {% else %}bg-gray-100 text-gray-700{% endif %}">
            {{ annotation.type|capitalize }}
        </span>
    </div>

    <!-- Contenu -->
    <div class="text-sm text-gray-700 mb-2 annotation-content">{{ annotation.content|markdown_to_html }}</div>

    <!-- Mentions -->
    {% if annotation.mentions|default([])|length > 0 %}
        <div class="flex flex-wrap gap-1 mb-2">
            {% for mention in annotation.mentions %}
                <span class="text-xs text-blue-600">@{{ mention }}</span>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Statut et actions -->
    <div class="flex items-center justify-between text-xs text-gray-500">
        <span title="{{ annotation.createdAt|date('d/m/Y H:i:s') }}">
            {{ annotation.createdAt|date('H:i') }}
        </span>
        <div class="flex items-center space-x-2">
            {% if annotation.status == 'resolved' %}
                <span class="text-green-600 flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Résolu
                </span>
            {% elseif annotation.takenIntoAccount %}
                <span class="text-blue-600 flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                    </svg>
                    Pris en compte
                </span>
            {% else %}
                <button hx-post="/api/annotations/{{ annotation.id }}/resolve"
                        hx-vals='{"participant_id": "{{ participant.id }}"}'
                        hx-target="#annotation-{{ annotation.id }}"
                        hx-swap="outerHTML"
                        class="text-gray-400 hover:text-green-600">
                    Résoudre
                </button>
            {% endif %}

            <button onclick="document.getElementById('reply-form-{{ annotation.id }}').classList.toggle('hidden')"
                    class="text-gray-400 hover:text-blue-600">
                Répondre
            </button>
        </div>
    </div>

    <!-- Réponses -->
    {% if annotation.replies|default([])|length > 0 %}
        <div class="mt-3 pl-3 border-l-2 border-gray-200 space-y-2">
            {% for reply in annotation.replies %}
                <div class="text-sm">
                    <div class="flex items-center space-x-1 mb-1">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-white text-xs"
                              style="background-color: {{ reply.author.color }}">
                            {{ reply.author.pseudo|first|upper }}
                        </span>
                        <span class="font-medium text-gray-700">{{ reply.author.pseudo }}</span>
                        <span class="text-gray-400">{{ reply.createdAt|date('H:i') }}</span>
                    </div>
                    <div class="text-gray-600 annotation-content">{{ reply.content|markdown_to_html }}</div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Formulaire de réponse (caché par défaut) -->
    <div id="reply-form-{{ annotation.id }}" class="hidden mt-3">
        <form hx-post="/api/annotations/{{ annotation.id }}/replies"
              hx-target="#annotation-{{ annotation.id }}"
              hx-swap="outerHTML"
              class="flex space-x-2">
            <input type="hidden" name="participant_id" value="{{ participant.id }}">
            <input type="text"
                   name="content"
                   required
                   placeholder="Votre réponse..."
                   class="flex-1 text-sm border-gray-300 rounded px-2 py-1 border">
            <button type="submit" class="px-2 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                Envoyer
            </button>
        </form>
    </div>
</div>
