<div class="mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200"
     id="decision-{{ decision.id }}"
     hx-ext="sse"
     sse-connect="{{ mercure_url }}?topic={{ ('/sessions/' ~ session.id ~ '/decisions')|url_encode }}">

    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-blue-900">{{ decision.title }}</h3>
        <span class="px-3 py-1 text-sm rounded-full
            {% if decision.status == 'ouvert' %}bg-gray-100 text-gray-700
            {% elseif decision.status == 'en_discussion' %}bg-yellow-100 text-yellow-700
            {% elseif decision.status == 'consensus' %}bg-green-100 text-green-700
            {% elseif decision.status == 'valide' %}bg-blue-100 text-blue-700
            {% else %}bg-red-100 text-red-700{% endif %}">
            {{ decision.status|replace({'_': ' '})|capitalize }}
        </span>
    </div>

    {% if decision.description %}
        <p class="text-sm text-blue-800 mb-4">{{ decision.description }}</p>
    {% endif %}

    <!-- Options avec votes -->
    <div class="space-y-3" id="decision-options-{{ decision.id }}" sse-swap="vote.received:innerHTML">
        {% set voteStats = decision.voteStats|default({}) %}
        {% set currentVote = decision.getVoteForParticipant(participant)|default(null) %}

        {% for option in decision.options %}
            <div class="flex items-center p-3 bg-white rounded border {{ currentVote and currentVote.optionId.toString == option.id ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-200' }}">
                {% if not decision.isLocked %}
                    <input type="radio"
                           name="vote-{{ decision.id }}"
                           id="option-{{ option.id }}"
                           value="{{ option.id }}"
                           {{ currentVote and currentVote.optionId.toString == option.id ? 'checked' : '' }}
                           hx-post="/api/decisions/{{ decision.id }}/vote"
                           hx-vals='{"participant_id": "{{ participant.id }}", "option_id": "{{ option.id }}"}'
                           hx-swap="none"
                           class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                {% endif %}
                <label for="option-{{ option.id }}" class="ml-3 flex-1 cursor-pointer">
                    <span class="font-medium text-gray-900">{{ option.label }}</span>
                    {% if option.description %}
                        <p class="text-sm text-gray-500">{{ option.description }}</p>
                    {% endif %}
                </label>
                <div class="text-sm text-gray-500 font-medium">
                    {{ voteStats[option.id]|default(0) }} vote(s)
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Résumé des votes -->
    <div class="mt-4 pt-4 border-t border-blue-200">
        <div class="flex justify-between text-sm text-blue-800">
            <span>Total : {{ decision.votes|length }} vote(s)</span>
            {% if decision.selectedOptionId %}
                <span class="font-medium">
                    Décision validée :
                    {% for option in decision.options if option.id == decision.selectedOptionId.toString %}
                        {{ option.label }}
                    {% endfor %}
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Actions (si pas verrouillé) -->
    {% if not decision.isLocked %}
        <div class="mt-4 flex justify-end space-x-2">
            {% if decision.status == 'ouvert' %}
                <button hx-patch="/api/decisions/{{ decision.id }}/status"
                        hx-vals='{"status": "en_discussion"}'
                        hx-target="#decision-{{ decision.id }}"
                        hx-swap="outerHTML"
                        class="px-3 py-1.5 text-sm bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200">
                    Ouvrir discussion
                </button>
            {% elseif decision.status == 'en_discussion' %}
                <button hx-patch="/api/decisions/{{ decision.id }}/status"
                        hx-vals='{"status": "consensus"}'
                        hx-target="#decision-{{ decision.id }}"
                        hx-swap="outerHTML"
                        class="px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                    Marquer consensus
                </button>
            {% endif %}

            <button hx-post="/api/decisions/{{ decision.id }}/postpone"
                    hx-target="#decision-{{ decision.id }}"
                    hx-swap="outerHTML"
                    class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                Reporter
            </button>
        </div>
    {% endif %}
</div>
